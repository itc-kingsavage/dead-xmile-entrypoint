<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DEAD-XMILE | Session Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Main Styles -->
  <link rel="stylesheet" href="./css/style.css">
</head>

<body>

  <!-- Background image reused for pairing -->
  <div class="bg"></div>

  <img id="logo" src="./img/logo.png" alt="Scanner Logo">

  <h1>ðŸ”¥ DEAD-X-BOT SCANNER ðŸ”¥</h1>
  <p>Generate QR or Pairing Code to link WhatsApp</p>

  <div class="scanner-box">

    <!-- MODE BUTTONS -->
    <div class="mode-switch">
      <button onclick="switchMode('qr')">QR MODE</button>
      <button onclick="switchMode('pair')">PAIR MODE</button>
    </div>

    <p id="status" class="loader">Select a mode to continue</p>

    <!-- QR IMAGE -->
    <img id="qrImage" style="display:none;" />

    <!-- PAIRING -->
    <div id="pairBox" style="display:none;">
      <input id="phoneInput" placeholder="2557XXXXXXXX" />
      <button onclick="generatePairing()">Generate Pairing Code</button>

      <div id="pairCodeBox" style="display:none;">
        <p><b>Pairing Code</b></p>
        <h2 id="pairCode"></h2>
      </div>
    </div>

    <!-- SESSION -->
    <div id="sessionBox" style="display:none;">
      <p><b>Session ID</b></p>
      <input id="sessionId" readonly />
      <br>
      <button id="copyBtn">Copy Session ID</button>
    </div>

    <button id="regenBtn" onclick="generateQR()">Generate New QR</button>

  </div>

<script>
const qrImg = document.getElementById("qrImage");
const statusText = document.getElementById("status");
const sessionBox = document.getElementById("sessionBox");
const sessionInput = document.getElementById("sessionId");
const copyBtn = document.getElementById("copyBtn");
const regenBtn = document.getElementById("regenBtn");

const pairBox = document.getElementById("pairBox");
const phoneInput = document.getElementById("phoneInput");
const pairCodeBox = document.getElementById("pairCodeBox");
const pairCodeText = document.getElementById("pairCode");

let mode = "qr";
let busy = false;

function switchMode(m) {
  mode = m;

  qrImg.style.display = "none";
  pairBox.style.display = "none";
  pairCodeBox.style.display = "none";
  sessionBox.style.display = "none";

  statusText.innerText =
    m === "qr"
      ? "Click Generate QR"
      : "Enter phone number to pair";

  if (m === "pair") {
    pairBox.style.display = "block";
    regenBtn.style.display = "none";
  } else {
    regenBtn.style.display = "inline-block";
  }
}

async function generateQR() {
  if (busy) return;
  busy = true;

  statusText.innerText = "Generating QR...";
  qrImg.style.display = "none";
  sessionBox.style.display = "none";

  try {
    const res = await fetch("/qr?mode=qr");
    const data = await res.json();

    if (!data.success) {
      statusText.innerText = data.error || "Failed to generate QR";
      busy = false;
      return;
    }

    qrImg.src = data.qr;
    qrImg.style.display = "block";

    sessionInput.value = data.sessionId;
    sessionBox.style.display = "block";

    statusText.innerText = `Scan QR within ${data.expiresIn / 1000}s`;

  } catch {
    statusText.innerText = "Network error";
  }

  setTimeout(() => busy = false, 3000);
}

async function generatePairing() {
  const phone = phoneInput.value.trim();
  if (!phone) {
    statusText.innerText = "Enter phone number";
    return;
  }

  statusText.innerText = "Generating pairing code...";
  pairCodeBox.style.display = "none";

  try {
    const res = await fetch("/qr?mode=pair", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ phone })
    });

    const data = await res.json();

    if (!data.success) {
      statusText.innerText = data.error;
      return;
    }

    pairCodeText.innerText = data.pairingCode;
    pairCodeBox.style.display = "block";

    sessionInput.value = data.sessionId;
    sessionBox.style.display = "block";

    statusText.innerText = "Enter code in WhatsApp";

  } catch {
    statusText.innerText = "Network error";
  }
}

copyBtn.onclick = () => {
  sessionInput.select();
  document.execCommand("copy");
  statusText.innerText = "Session ID copied âœ“";
};
</script>
</body>
</html>
